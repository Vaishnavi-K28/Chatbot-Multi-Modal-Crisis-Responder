<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrisisAI ‚Äî Multi-Modal Emergency Responder</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #060910;
      --surface: #0d1117;
      --surface2: #131a24;
      --border: #1e2d3d;
      --accent: #ff3c3c;
      --accent2: #ff7c3c;
      --green: #22c55e;
      --yellow: #eab308;
      --blue: #3b82f6;
      --text: #e8edf3;
      --muted: #556070;
      --glow: rgba(255, 60, 60, 0.15);
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      line-height: 1.6;
      overflow: hidden;
    }

    /* Animated background grid */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(30,45,61,0.3) 1px, transparent 1px),
        linear-gradient(90deg, rgba(30,45,61,0.3) 1px, transparent 1px);
      background-size: 48px 48px;
      z-index: 0;
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      top: -50%;
      left: -20%;
      width: 70%;
      height: 80%;
      background: radial-gradient(ellipse, rgba(255,60,60,0.06) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
      animation: driftGlow 12s ease-in-out infinite alternate;
    }

    @keyframes driftGlow {
      from { transform: translate(0, 0) scale(1); }
      to   { transform: translate(15%, 10%) scale(1.2); }
    }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .app {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 56px 1fr;
      height: 100vh;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      padding: 0 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(6,9,16,0.9);
      backdrop-filter: blur(12px);
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 18px;
      letter-spacing: -0.5px;
    }

    .logo-icon {
      width: 28px; height: 28px;
      background: var(--accent);
      border-radius: 8px;
      display: grid;
      place-items: center;
      animation: pulse-icon 2.5s ease-in-out infinite;
    }

    @keyframes pulse-icon {
      0%,100% { box-shadow: 0 0 0 0 rgba(255,60,60,0.6); }
      50%      { box-shadow: 0 0 0 8px rgba(255,60,60,0); }
    }

    .logo-icon svg { width: 16px; height: 16px; fill: #fff; }

    .status-bar {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .status-dot {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
    }

    .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--green);
      animation: blink 2s step-end infinite;
    }

    @keyframes blink {
      0%,100% { opacity: 1; }
      50%      { opacity: 0.2; }
    }

    .header-btn {
      padding: 6px 14px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      font-size: 12px;
      font-family: 'DM Mono', monospace;
      cursor: pointer;
      transition: all .2s;
    }
    .header-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    aside {
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-label {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    /* Mode selector */
    .mode-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mode-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all .2s;
      border: 1px solid transparent;
      font-size: 13px;
    }

    .mode-item:hover { background: var(--surface2); }

    .mode-item.active {
      background: rgba(255,60,60,0.08);
      border-color: rgba(255,60,60,0.25);
      color: #ff7a7a;
    }

    .mode-icon {
      width: 30px; height: 30px;
      border-radius: 7px;
      background: var(--surface2);
      display: grid;
      place-items: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .mode-item.active .mode-icon {
      background: rgba(255,60,60,0.15);
    }

    /* Severity */
    .severity-list { display: flex; flex-direction: column; gap: 6px; }

    .sev-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background .15s;
    }
    .sev-item:hover { background: var(--surface2); }
    .sev-item span { color: var(--muted); font-family: 'DM Mono', monospace; font-size: 11px; }

    .sev-badge {
      width: 8px; height: 8px;
      border-radius: 50%;
    }
    .sev-badge.critical { background: #ef4444; box-shadow: 0 0 6px #ef4444; }
    .sev-badge.high     { background: #f97316; }
    .sev-badge.medium   { background: #eab308; }
    .sev-badge.low      { background: #22c55e; }

    /* History */
    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .history-list::-webkit-scrollbar { width: 4px; }
    .history-list::-webkit-scrollbar-track { background: transparent; }
    .history-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    .hist-item {
      padding: 8px 10px;
      border-radius: 7px;
      cursor: pointer;
      transition: background .15s;
      font-size: 12px;
      color: var(--muted);
    }
    .hist-item:hover { background: var(--surface2); color: var(--text); }
    .hist-item .hist-time { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); margin-top: 2px; }

    /* ‚îÄ‚îÄ Main Chat ‚îÄ‚îÄ */
    main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: rgba(13,17,23,0.7);
      backdrop-filter: blur(8px);
    }

    .tool-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
      font-family: 'DM Sans', sans-serif;
    }
    .tool-btn:hover { border-color: var(--accent); background: rgba(255,60,60,0.05); }
    .tool-btn.active { border-color: var(--accent); background: rgba(255,60,60,0.1); color: #ff7a7a; }

    .tool-btn svg { width: 14px; height: 14px; }

    .emergency-btn {
      margin-left: auto;
      padding: 7px 18px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all .2s;
      box-shadow: 0 0 20px rgba(255,60,60,0.3);
      animation: pulse-btn 3s ease-in-out infinite;
    }

    @keyframes pulse-btn {
      0%,100% { box-shadow: 0 0 20px rgba(255,60,60,0.3); }
      50%      { box-shadow: 0 0 30px rgba(255,60,60,0.5); }
    }

    .emergency-btn:hover { background: #ff5252; transform: translateY(-1px); }

    /* Chat area */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .chat-area::-webkit-scrollbar { width: 5px; }
    .chat-area::-webkit-scrollbar-track { background: transparent; }
    .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    /* Welcome card */
    .welcome-card {
      background: linear-gradient(135deg, rgba(255,60,60,0.08), rgba(255,124,60,0.04));
      border: 1px solid rgba(255,60,60,0.2);
      border-radius: 16px;
      padding: 28px;
      text-align: center;
    }

    .welcome-card h1 {
      font-family: 'Syne', sans-serif;
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, #ff3c3c, #ff7c3c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .welcome-card p { color: var(--muted); font-size: 14px; max-width: 440px; margin: 0 auto 20px; }

    .caps-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 16px;
    }

    .cap-item {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 10px;
      font-size: 12px;
    }

    .cap-item .cap-icon { font-size: 22px; margin-bottom: 6px; }
    .cap-item .cap-title { font-weight: 500; margin-bottom: 2px; }
    .cap-item .cap-desc { color: var(--muted); font-size: 11px; }

    /* Messages */
    .message {
      display: flex;
      gap: 12px;
      animation: slideIn .3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .message.user { flex-direction: row-reverse; }

    .avatar {
      width: 34px; height: 34px;
      border-radius: 10px;
      flex-shrink: 0;
      display: grid;
      place-items: center;
      font-size: 16px;
    }

    .avatar.bot {
      background: linear-gradient(135deg, rgba(255,60,60,0.2), rgba(255,124,60,0.1));
      border: 1px solid rgba(255,60,60,0.3);
    }

    .avatar.user-av {
      background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(59,130,246,0.1));
      border: 1px solid rgba(59,130,246,0.3);
    }

    .bubble {
      max-width: 72%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      font-size: 14px;
      line-height: 1.65;
    }

    .message.user .bubble {
      background: rgba(59,130,246,0.08);
      border-color: rgba(59,130,246,0.2);
    }

    .bubble .meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 11px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
    }

    .severity-tag {
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .severity-tag.critical { background: rgba(239,68,68,0.15); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
    .severity-tag.high     { background: rgba(249,115,22,0.15); color: #f97316; border: 1px solid rgba(249,115,22,0.3); }
    .severity-tag.medium   { background: rgba(234,179,8,0.15);  color: #eab308; border: 1px solid rgba(234,179,8,0.3); }

    .steps-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .step {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .step-num {
      width: 22px; height: 22px;
      border-radius: 6px;
      background: rgba(255,60,60,0.15);
      border: 1px solid rgba(255,60,60,0.3);
      display: grid;
      place-items: center;
      font-size: 11px;
      font-family: 'DM Mono', monospace;
      color: var(--accent);
      flex-shrink: 0;
      margin-top: 2px;
    }

    /* Image preview */
    .img-preview {
      max-width: 220px;
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-top: 8px;
    }

    /* Voice wave */
    .voice-wave {
      display: flex;
      align-items: center;
      gap: 3px;
      height: 30px;
      padding: 6px 0;
    }

    .wave-bar {
      width: 3px;
      background: var(--accent);
      border-radius: 2px;
      animation: waveAnim 1s ease-in-out infinite;
    }

    .wave-bar:nth-child(1) { animation-delay: 0s;    height: 8px; }
    .wave-bar:nth-child(2) { animation-delay: .1s;   height: 16px; }
    .wave-bar:nth-child(3) { animation-delay: .2s;   height: 22px; }
    .wave-bar:nth-child(4) { animation-delay: .3s;   height: 16px; }
    .wave-bar:nth-child(5) { animation-delay: .4s;   height: 10px; }
    .wave-bar:nth-child(6) { animation-delay: .5s;   height: 18px; }
    .wave-bar:nth-child(7) { animation-delay: .6s;   height: 12px; }

    @keyframes waveAnim {
      0%,100% { transform: scaleY(1); opacity: .8; }
      50%      { transform: scaleY(1.8); opacity: 1; }
    }

    /* Typing indicator */
    .typing {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 10px 14px;
    }

    .typing span {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--muted);
      animation: typingDot 1.4s ease-in-out infinite;
    }

    .typing span:nth-child(2) { animation-delay: .2s; }
    .typing span:nth-child(3) { animation-delay: .4s; }

    @keyframes typingDot {
      0%,80%,100% { transform: scale(.8); opacity: .4; }
      40%          { transform: scale(1.2); opacity: 1; }
    }

    /* ‚îÄ‚îÄ Input Area ‚îÄ‚îÄ */
    .input-zone {
      padding: 14px 20px 18px;
      border-top: 1px solid var(--border);
      background: rgba(13,17,23,0.9);
      backdrop-filter: blur(10px);
    }

    /* Image drop zone */
    .drop-zone {
      display: none;
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 12px;
      transition: all .2s;
      cursor: pointer;
    }

    .drop-zone.active { display: block; }
    .drop-zone.dragover { border-color: var(--accent); background: rgba(255,60,60,0.04); color: var(--text); }

    .preview-strip {
      display: none;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .preview-strip.active { display: flex; }

    .preview-thumb {
      position: relative;
      width: 56px; height: 56px;
    }

    .preview-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .preview-thumb .remove {
      position: absolute;
      top: -5px; right: -5px;
      width: 16px; height: 16px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: #fff;
      font-size: 10px;
      cursor: pointer;
      display: grid;
      place-items: center;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .input-wrapper {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: flex;
      align-items: flex-end;
      gap: 6px;
      padding: 10px 12px;
      transition: border-color .2s;
    }

    .input-wrapper:focus-within { border-color: rgba(255,60,60,0.4); }

    #messageInput {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
      font-family: 'DM Sans', sans-serif;
      resize: none;
      max-height: 120px;
      min-height: 20px;
      line-height: 1.5;
    }

    #messageInput::placeholder { color: var(--muted); }

    .input-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .icon-btn {
      width: 30px; height: 30px;
      border-radius: 7px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all .2s;
    }

    .icon-btn:hover { background: var(--surface2); color: var(--text); border-color: var(--border); }
    .icon-btn.recording { color: var(--accent); border-color: rgba(255,60,60,0.4); background: rgba(255,60,60,0.08); animation: pulse-icon 1s infinite; }

    .icon-btn svg { width: 15px; height: 15px; }

    .send-btn {
      width: 44px; height: 44px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #fff;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all .2s;
      flex-shrink: 0;
      box-shadow: 0 4px 14px rgba(255,60,60,0.35);
    }

    .send-btn:hover { background: #ff5252; transform: translateY(-1px); }
    .send-btn svg { width: 18px; height: 18px; }

    .char-count {
      text-align: right;
      font-size: 10px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      margin-top: 6px;
    }

    /* Notification Toast */
    .toast {
      position: fixed;
      top: 70px;
      right: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 13px;
      z-index: 100;
      animation: toastIn .3s ease;
      max-width: 300px;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateX(20px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app { grid-template-columns: 1fr; }
      aside { display: none; }
    }
  </style>
</head>
<body>

<div class="app">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      CrisisAI
    </div>
    <span style="color:var(--muted);font-size:12px;margin-left:4px">Multi-Modal Emergency Responder</span>
    <div class="status-bar">
      <div class="status-dot"><span class="dot"></span> SYSTEM ONLINE</div>
      <button class="header-btn" id="clearBtn">CLEAR SESSION</button>
      <button class="header-btn" id="exportBtn">EXPORT LOG</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside>
    <div class="sidebar-section">
      <div class="sidebar-label">Input Mode</div>
      <div class="mode-list">
        <div class="mode-item active" data-mode="text" onclick="setMode('text',this)">
          <div class="mode-icon">üí¨</div>
          <div>
            <div style="font-weight:500">Text Chat</div>
            <div style="font-size:11px;color:var(--muted)">Type your emergency</div>
          </div>
        </div>
        <div class="mode-item" data-mode="voice" onclick="setMode('voice',this)">
          <div class="mode-icon">üéôÔ∏è</div>
          <div>
            <div style="font-weight:500">Voice Input</div>
            <div style="font-size:11px;color:var(--muted)">Speak your situation</div>
          </div>
        </div>
        <div class="mode-item" data-mode="image" onclick="setMode('image',this)">
          <div class="mode-icon">üì∏</div>
          <div>
            <div style="font-weight:500">Image Upload</div>
            <div style="font-size:11px;color:var(--muted)">Photo of incident</div>
          </div>
        </div>
        <div class="mode-item" data-mode="multi" onclick="setMode('multi',this)">
          <div class="mode-icon">‚ö°</div>
          <div>
            <div style="font-weight:500">Multi-Modal</div>
            <div style="font-size:11px;color:var(--muted)">Combine all inputs</div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Severity Levels</div>
      <div class="severity-list">
        <div class="sev-item"><span class="sev-badge critical"></span> Critical <span>Life-threatening</span></div>
        <div class="sev-item"><span class="sev-badge high"></span> High <span>Urgent action</span></div>
        <div class="sev-item"><span class="sev-badge medium"></span> Medium <span>Needs attention</span></div>
        <div class="sev-item"><span class="sev-badge low"></span> Low <span>Non-urgent</span></div>
      </div>
    </div>

    <div class="sidebar-label" style="padding:16px 16px 8px">Session History</div>
    <div class="history-list" id="historyList">
      <div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">No history yet</div>
    </div>
  </aside>

  <!-- MAIN -->
  <main>
    <div class="toolbar">
      <button class="tool-btn active" id="modeTextBtn" onclick="quickMode('text')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Text
      </button>
      <button class="tool-btn" id="modeVoiceBtn" onclick="quickMode('voice')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/></svg>
        Voice
      </button>
      <button class="tool-btn" id="modeImgBtn" onclick="quickMode('image')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
        Image
      </button>
      <button class="tool-btn" onclick="quickScenario('fire')">üî• Fire</button>
      <button class="tool-btn" onclick="quickScenario('accident')">üöó Accident</button>
      <button class="tool-btn" onclick="quickScenario('medical')">üè• Medical</button>
      <button class="emergency-btn" onclick="callEmergency()">‚ö° EMERGENCY CALL</button>
    </div>

    <div class="chat-area" id="chatArea">
      <!-- Welcome -->
      <div class="welcome-card" id="welcomeCard">
        <h1>CrisisAI Responder</h1>
        <p>I'm your AI emergency assistant. Describe your situation via text, voice, or photo and I'll provide immediate guidance.</p>
        <div class="caps-grid">
          <div class="cap-item">
            <div class="cap-icon">üí¨</div>
            <div class="cap-title">Text Analysis</div>
            <div class="cap-desc">Describe your emergency in words</div>
          </div>
          <div class="cap-item">
            <div class="cap-icon">üéôÔ∏è</div>
            <div class="cap-title">Voice Input</div>
            <div class="cap-desc">Speak directly for hands-free use</div>
          </div>
          <div class="cap-item">
            <div class="cap-icon">üì∏</div>
            <div class="cap-title">Image Analysis</div>
            <div class="cap-desc">Upload photos of accidents or injuries</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Zone -->
    <div class="input-zone">
      <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        üìé Drop images here or click to upload ‚Äî photos of accidents, injuries, or hazards
        <input type="file" id="fileInput" accept="image/*" multiple style="display:none" onchange="handleFiles(this.files)">
      </div>

      <div class="preview-strip" id="previewStrip"></div>

      <div class="input-row">
        <div class="input-wrapper">
          <textarea id="messageInput" rows="1" placeholder="Describe your emergency situation..." maxlength="2000"
            oninput="autoGrow(this); updateCount(this)"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"
          ></textarea>
          <div class="input-actions">
            <button class="icon-btn" id="voiceBtn" title="Voice Input" onclick="toggleVoice()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/></svg>
            </button>
            <button class="icon-btn" title="Attach Image" onclick="document.getElementById('fileInput').click()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
            </button>
          </div>
        </div>
        <button class="send-btn" onclick="sendMessage()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
      <div class="char-count" id="charCount">0 / 2000</div>
    </div>
  </main>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let currentMode = 'text';
let isRecording = false;
let recognition = null;
let attachedImages = [];
let messageHistory = [];
let historyItems = [];

// ‚îÄ‚îÄ Mode ‚îÄ‚îÄ
function setMode(mode, el) {
  currentMode = mode;
  document.querySelectorAll('.mode-item').forEach(m => m.classList.remove('active'));
  el.classList.add('active');
  updateUI();
}

function quickMode(mode) {
  currentMode = mode;
  document.querySelectorAll('[data-mode]').forEach(m => m.classList.toggle('active', m.dataset.mode === mode));
  document.querySelectorAll('.tool-btn[id]').forEach(b => b.classList.remove('active'));
  const map = { text: 'modeTextBtn', voice: 'modeVoiceBtn', image: 'modeImgBtn' };
  if (map[mode]) document.getElementById(map[mode])?.classList.add('active');
  updateUI();
}

function updateUI() {
  const dropZone = document.getElementById('dropZone');
  const input = document.getElementById('messageInput');
  if (currentMode === 'image') {
    dropZone.classList.add('active');
    input.placeholder = 'Optional: describe what you see...';
  } else if (currentMode === 'voice') {
    dropZone.classList.remove('active');
    input.placeholder = 'Click the mic or start speaking...';
  } else if (currentMode === 'multi') {
    dropZone.classList.add('active');
    input.placeholder = 'Describe and/or attach image, or use voice...';
  } else {
    dropZone.classList.remove('active');
    input.placeholder = 'Describe your emergency situation...';
  }
}

// ‚îÄ‚îÄ Emergency scenarios ‚îÄ‚îÄ
const scenarios = {
  fire: "There's a fire in my building. Smoke is filling the hallway and I can see flames on the 3rd floor. I'm on the 4th floor with two people.",
  accident: "I witnessed a severe car accident on the highway. One vehicle has overturned. I can see at least 2 injured people. There is fuel leaking.",
  medical: "Someone collapsed next to me. They are unconscious and not responding. I don't know if they are breathing. What should I do?"
};

function quickScenario(type) {
  document.getElementById('messageInput').value = scenarios[type];
  autoGrow(document.getElementById('messageInput'));
  updateCount(document.getElementById('messageInput'));
  showToast(`Scenario loaded: ${type.toUpperCase()}`, 'info');
}

// ‚îÄ‚îÄ Voice ‚îÄ‚îÄ
function toggleVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showToast('Speech recognition not supported in this browser.', 'warn');
    return;
  }
  if (isRecording) {
    stopVoice();
  } else {
    startVoice();
  }
}

function startVoice() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onstart = () => {
    isRecording = true;
    document.getElementById('voiceBtn').classList.add('recording');
    showToast('Listening... Speak clearly.', 'info');
  };

  recognition.onresult = (e) => {
    let transcript = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      transcript += e.results[i][0].transcript;
    }
    document.getElementById('messageInput').value = transcript;
    autoGrow(document.getElementById('messageInput'));
    updateCount(document.getElementById('messageInput'));
  };

  recognition.onerror = () => stopVoice();
  recognition.onend = () => { if (isRecording) stopVoice(); };
  recognition.start();
}

function stopVoice() {
  isRecording = false;
  document.getElementById('voiceBtn').classList.remove('recording');
  if (recognition) { recognition.stop(); recognition = null; }
}

// ‚îÄ‚îÄ Image handling ‚îÄ‚îÄ
function handleFiles(files) {
  for (const f of files) {
    if (!f.type.startsWith('image/')) continue;
    const reader = new FileReader();
    reader.onload = (e) => {
      attachedImages.push({ data: e.target.result, name: f.name });
      renderPreviews();
    };
    reader.readAsDataURL(f);
  }
}

function renderPreviews() {
  const strip = document.getElementById('previewStrip');
  strip.innerHTML = '';
  if (attachedImages.length === 0) { strip.classList.remove('active'); return; }
  strip.classList.add('active');
  attachedImages.forEach((img, i) => {
    const div = document.createElement('div');
    div.className = 'preview-thumb';
    div.innerHTML = `<img src="${img.data}"><button class="remove" onclick="removeImg(${i})">‚úï</button>`;
    strip.appendChild(div);
  });
}

function removeImg(i) {
  attachedImages.splice(i, 1);
  renderPreviews();
}

// Drag & drop
const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});

// ‚îÄ‚îÄ Send Message ‚îÄ‚îÄ
async function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text && attachedImages.length === 0) return;

  hideWelcome();

  // User message
  addUserMessage(text, [...attachedImages]);
  addToHistory(text || 'Image analysis', currentMode);

  // Reset
  input.value = '';
  autoGrow(input);
  updateCount(input);
  const imgs = [...attachedImages];
  attachedImages = [];
  renderPreviews();

  // Show typing
  const typingId = showTyping();

  // Get AI response
  try {
    const res = await fetch('/api/crisis', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text, images: imgs.map(i=>i.data), mode: currentMode })
    });
    const data = await res.json();
    removeTyping(typingId);
    addBotMessage(data);
  } catch {
    removeTyping(typingId);
    // Demo response if server not connected
    addBotMessage(getDemoResponse(text, imgs));
  }
}

function addUserMessage(text, imgs) {
  const chatArea = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'message user';
  let imgHtml = imgs.map(i => `<img class="img-preview" src="${i.data}">`).join('');
  let voiceHtml = (currentMode === 'voice') ? `<div class="voice-wave">${Array(7).fill('<div class="wave-bar"></div>').join('')}</div>` : '';

  div.innerHTML = `
    <div class="avatar user-av">üë§</div>
    <div class="bubble">
      <div class="meta">${new Date().toLocaleTimeString()} ¬∑ ${currentMode.toUpperCase()}</div>
      ${voiceHtml}
      ${text ? `<div>${escHtml(text)}</div>` : ''}
      ${imgHtml}
    </div>
  `;
  chatArea.appendChild(div);
  scrollChat();
}

function addBotMessage(data) {
  const chatArea = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'message bot';

  const sevClass = (data.severity||'medium').toLowerCase();
  const stepsHtml = data.steps ? `
    <div class="steps-list">
      ${data.steps.map((s,i) => `
        <div class="step">
          <div class="step-num">${i+1}</div>
          <div>${escHtml(s)}</div>
        </div>`).join('')}
    </div>` : '';

  div.innerHTML = `
    <div class="avatar bot">üö®</div>
    <div class="bubble">
      <div class="meta">
        CrisisAI ¬∑ ${new Date().toLocaleTimeString()}
        ${data.severity ? `<span class="severity-tag ${sevClass}">${data.severity}</span>` : ''}
      </div>
      <div>${data.message || ''}</div>
      ${stepsHtml}
      ${data.callEmergency ? `<div style="margin-top:10px;padding:8px 12px;background:rgba(255,60,60,0.08);border:1px solid rgba(255,60,60,0.2);border-radius:8px;font-size:13px;color:#ff7a7a">üìû <strong>CALL EMERGENCY SERVICES IMMEDIATELY: 911</strong></div>` : ''}
    </div>
  `;
  chatArea.appendChild(div);
  scrollChat();

  // Save to history
  messageHistory.push({ role: 'bot', ...data });
}

function showTyping() {
  const chatArea = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'message bot';
  const id = 'typing_' + Date.now();
  div.id = id;
  div.innerHTML = `
    <div class="avatar bot">üö®</div>
    <div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>
  `;
  chatArea.appendChild(div);
  scrollChat();
  return id;
}

function removeTyping(id) {
  document.getElementById(id)?.remove();
}

// ‚îÄ‚îÄ Demo AI Response (fallback) ‚îÄ‚îÄ
function getDemoResponse(text, imgs) {
  const lower = text.toLowerCase();
  let severity = 'MEDIUM';
  let callEmergency = false;
  let message = '';
  let steps = [];

  if (imgs.length > 0) {
    message = "I've analyzed the image you sent. Based on visual cues, this appears to be an emergency situation requiring immediate attention. Please follow these critical steps:";
    severity = 'HIGH';
    callEmergency = true;
    steps = [
      "Ensure you and others are at a safe distance from the hazard",
      "Call emergency services (911) immediately with your exact location",
      "Do not attempt to move injured persons unless there is immediate danger",
      "Keep bystanders away from the scene",
      "Monitor for changes and relay updates to responders"
    ];
  } else if (lower.includes('fire') || lower.includes('smoke') || lower.includes('flame')) {
    severity = 'CRITICAL';
    callEmergency = true;
    message = "‚ö†Ô∏è FIRE EMERGENCY DETECTED. This is a life-threatening situation. Immediate action required.";
    steps = [
      "Activate the nearest fire alarm if not already triggered",
      "Call 911 immediately ‚Äî state your exact address and floor",
      "Do NOT use elevators ‚Äî use stairwells to evacuate",
      "Feel doors before opening ‚Äî if hot, find another route",
      "Stay low to avoid smoke inhalation while evacuating",
      "Once outside, move 300+ feet from the building and await responders",
      "Never re-enter the building for any reason"
    ];
  } else if (lower.includes('accident') || lower.includes('crash') || lower.includes('collision')) {
    severity = 'CRITICAL';
    callEmergency = true;
    message = "Vehicle accident detected. Prioritize safety and medical response.";
    steps = [
      "Call 911 ‚Äî report number of vehicles, estimated injuries, and hazards (fuel leak, fire)",
      "Turn on hazard lights and set up warning triangles if available",
      "Do NOT move injured persons unless they are in immediate danger",
      "Check for pulse and breathing in unconscious victims",
      "Apply pressure to severe bleeding wounds using cloth or bandage",
      "Keep injured persons warm and calm until help arrives",
      "Secure the scene ‚Äî prevent others from driving through"
    ];
  } else if (lower.includes('heart') || lower.includes('chest pain') || lower.includes('collapsed') || lower.includes('unconscious') || lower.includes('not breathing')) {
    severity = 'CRITICAL';
    callEmergency = true;
    message = "Potential cardiac/medical emergency. Begin life-saving measures immediately.";
    steps = [
      "Call 911 immediately ‚Äî describe symptoms clearly",
      "Check for responsiveness ‚Äî tap shoulders and shout loudly",
      "If unresponsive and not breathing normally ‚Äî begin CPR immediately",
      "CPR: 30 chest compressions (hard and fast) + 2 rescue breaths",
      "Use an AED if one is available nearby",
      "Continue CPR until emergency services arrive",
      "If conscious: have them sit or lie down, loosen tight clothing, monitor breathing"
    ];
  } else {
    severity = 'MEDIUM';
    message = "Emergency situation acknowledged. I'm here to help. Please provide more details so I can give you the most relevant guidance.";
    steps = [
      "Ensure you and those around you are in a safe location",
      "Describe the nature of the emergency in more detail if possible",
      "If there are injuries, call 911 immediately",
      "Stay calm ‚Äî panic can make situations worse",
      "Follow any existing emergency protocols in your location"
    ];
  }

  return { severity, message, steps, callEmergency };
}

// ‚îÄ‚îÄ History ‚îÄ‚îÄ
function addToHistory(text, mode) {
  historyItems.unshift({ text: text.slice(0, 40) || 'Image', mode, time: new Date().toLocaleTimeString() });
  const list = document.getElementById('historyList');
  list.innerHTML = historyItems.slice(0, 10).map(h => `
    <div class="hist-item">
      <div>${h.mode === 'image' ? 'üì∏' : h.mode === 'voice' ? 'üéôÔ∏è' : 'üí¨'} ${escHtml(h.text)}${h.text.length >= 40 ? '...' : ''}</div>
      <div class="hist-time">${h.time}</div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function hideWelcome() {
  const w = document.getElementById('welcomeCard');
  if (w) w.style.display = 'none';
}

function scrollChat() {
  const ca = document.getElementById('chatArea');
  ca.scrollTop = ca.scrollHeight;
}

function autoGrow(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function updateCount(el) {
  document.getElementById('charCount').textContent = `${el.value.length} / 2000`;
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function callEmergency() {
  showToast('‚ö° EMERGENCY SERVICES ALERTED ‚Äî Dial 911 now for immediate assistance', 'alert');
}

function showToast(msg, type='info') {
  const old = document.querySelector('.toast');
  if (old) old.remove();
  const t = document.createElement('div');
  t.className = 'toast';
  const colors = { alert: '#ef4444', warn: '#f97316', info: '#3b82f6' };
  t.style.borderLeftColor = colors[type] || colors.info;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

document.getElementById('clearBtn').onclick = () => {
  document.getElementById('chatArea').innerHTML = '';
  historyItems = [];
  messageHistory = [];
  document.getElementById('historyList').innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">No history yet</div>';
  const wc = document.createElement('div');
  wc.id = 'welcomeCard';
  wc.className = 'welcome-card';
  wc.innerHTML = document.querySelector('.welcome-card')?.innerHTML || '';
  showToast('Session cleared', 'info');
};

document.getElementById('exportBtn').onclick = () => {
  const log = messageHistory.map(m => JSON.stringify(m)).join('\n');
  const blob = new Blob([log], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'crisis-session-' + Date.now() + '.txt';
  a.click();
  showToast('Session log exported', 'info');
};
</script>
</body>
</html>
